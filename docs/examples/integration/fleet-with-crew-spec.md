# Fleet with Crew-Generated Specifications

This example demonstrates how to use the Fleet system to spawn agents with specifications generated by CrewAI crews.

## Overview

The `spawnWithCrewSpec()` method combines the power of CrewAI's specialized crews with Fleet's agent orchestration. The crew generates a detailed specification, which is then used as the task for a Cursor Background Agent.

## Configuration

First, configure the crew tool in `agentic.config.json`:

```json
{
  "crews": {
    "pythonExecutable": "uv",
    "crewAgentsPath": "./python",
    "defaultTimeout": 300000,
    "env": {
      "ANTHROPIC_API_KEY": "ANTHROPIC_API_KEY"
    }
  }
}
```

## Basic Usage

```typescript
import { Fleet } from 'agentic-control';

const fleet = new Fleet();

// Spawn agent with crew-generated spec
const result = await fleet.spawnWithCrewSpec(
  'https://github.com/org/repo',
  'otterfall',           // Package name
  'game_builder',        // Crew name
  'Create a QuestComponent with reward system'  // Input for crew
);

if (result.success) {
  console.log(`Agent spawned: ${result.data.id}`);
  console.log(`Status: ${result.data.status}`);
} else {
  console.error(`Failed: ${result.error}`);
}
```

## With Spawn Options

```typescript
const result = await fleet.spawnWithCrewSpec(
  'https://github.com/org/repo',
  'otterfall',
  'game_builder',
  'Create a QuestComponent',
  {
    ref: 'develop',
    target: {
      autoCreatePr: true,
      branchName: 'feat/quest-component',
      openAsCursorGithubApp: true,
    },
  }
);
```

## Error Handling

```typescript
try {
  const result = await fleet.spawnWithCrewSpec(
    'https://github.com/org/repo',
    'otterfall',
    'game_builder',
    'Create a QuestComponent'
  );

  if (!result.success) {
    // Check if it's a crew execution error
    if (result.error?.includes('Crew execution failed')) {
      console.error('Crew failed to generate spec:', result.error);
    } else if (result.error?.includes('not configured')) {
      console.error('Crew tool not configured in agentic.config.json');
    } else {
      console.error('Agent spawn failed:', result.error);
    }
    return;
  }

  // Success - monitor the agent
  console.log(`Agent ${result.data.id} spawned successfully`);
  
  // Wait for completion
  const finalStatus = await fleet.waitFor(result.data.id, {
    timeout: 600000, // 10 minutes
    pollInterval: 10000, // Check every 10 seconds
  });

  if (finalStatus.success) {
    console.log(`Agent completed with status: ${finalStatus.data.status}`);
  }
} catch (error) {
  console.error('Unexpected error:', error);
}
```

## Monitoring Progress

```typescript
const result = await fleet.spawnWithCrewSpec(
  'https://github.com/org/repo',
  'otterfall',
  'game_builder',
  'Create a QuestComponent'
);

if (result.success) {
  const agentId = result.data.id;

  // Send follow-up messages
  await fleet.followup(agentId, 'Add unit tests for the QuestComponent');
  
  // Get conversation history
  const conv = await fleet.conversation(agentId);
  if (conv.success) {
    console.log(`Conversation has ${conv.data.totalMessages} messages`);
  }

  // Archive conversation when done
  await fleet.archive(agentId, `./archives/quest-component-${agentId}.json`);
}
```

## Multiple Agents with Different Crews

```typescript
// Spawn multiple agents with different crew-generated specs
const agents = await Promise.all([
  fleet.spawnWithCrewSpec(
    'https://github.com/org/game-engine',
    'otterfall',
    'ecs_implementation',
    'Implement ECS system for quests'
  ),
  fleet.spawnWithCrewSpec(
    'https://github.com/org/game-assets',
    'otterfall',
    'asset_pipeline',
    'Generate quest-related 3D assets'
  ),
  fleet.spawnWithCrewSpec(
    'https://github.com/org/game-ui',
    'otterfall',
    'gameplay_design',
    'Design quest UI components'
  ),
]);

// Monitor all agents
const agentIds = agents
  .filter(r => r.success)
  .map(r => r.data!.id);

const results = await fleet.monitorAgents(agentIds, {
  pollInterval: 15000,
  onProgress: (statusMap) => {
    console.log('Agent statuses:', Object.fromEntries(statusMap));
  },
});

console.log(`All ${results.size} agents completed`);
```

## Best Practices

1. **Validate Configuration**: Check that crew tool is configured before spawning
2. **Handle Timeouts**: Crew execution can take time, set appropriate timeouts
3. **Monitor Progress**: Use `waitFor()` or `monitorAgents()` to track completion
4. **Error Recovery**: Implement retry logic for transient failures
5. **Archive Conversations**: Save conversation history for debugging and analysis

## Common Issues

### Crew Tool Not Configured
```
Error: Crew tool not configured. Add crews section to agentic.config.json
```
**Solution**: Add crews configuration to your config file (see Configuration section)

### Crew Execution Timeout
```
Error: Crew execution failed: Crew execution timed out after 300000ms
```
**Solution**: Increase timeout in config or per-invocation:
```typescript
const result = await fleet.spawnWithCrewSpec(
  repo, pkg, crew, input,
  { timeout: 600000 } // 10 minutes
);
```

### Python Environment Not Found
```
Error: Failed to spawn process: ENOENT
```
**Solution**: Verify Python executable path in config:
```json
{
  "crews": {
    "pythonExecutable": "uv",  // or "python3", "python"
    "crewAgentsPath": "./python"
  }
}
```

## See Also

- [Triage with Crew Delegation](./triage-with-crew-delegation.md)
- [Error Handling Guide](./error-handling.md)
- [Configuration Guide](./configuration.md)
